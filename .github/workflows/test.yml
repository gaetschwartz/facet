# HANDWRITTEN: facet-dev hands off my pipelines

name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

jobs:
  test-x86_64-unknown-linux-gnu:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - name: Install system dependencies
        run: apt-get update && apt-get install -y zlib1g-dev

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run tests with coverage
        shell: bash
        run: |
          # Install nightly for coverage with doctests
          rustup toolchain install nightly

          # Run unit and integration tests with coverage
          cargo +nightly llvm-cov --no-report nextest --features ci

          # Run doc tests with coverage (requires nightly)
          cargo +nightly llvm-cov --no-report --doc --features ci

          # Generate merged coverage report
          mkdir coverage
          cargo +nightly llvm-cov report --doctests --lcov --output-path coverage/lcov.info

      - name: ✨ Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  nostd:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nostd tests
        shell: bash
        run: |
          just nostd-ci

  miri:
    runs-on: depot-ubuntu-24.04-64

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-miri-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run miri
        shell: bash
        run: |
          export CI=true
          just miri

  valgrind:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - name: Install valgrind and nodejs
        run: apt-get update && apt-get install -y valgrind nodejs

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run facet-json tests under valgrind
        shell: bash
        run: |
          just valgrind -p facet-json

  perf-divan:
    runs-on: depot-ubuntu-24.04-32

    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run divan benchmarks
        run: |
          cd facet-perf-shootout
          cargo bench --bench unified_divan --features jit | tee divan-output.txt

      - name: Upload divan results
        uses: actions/upload-artifact@v4
        with:
          name: divan-results
          path: facet-perf-shootout/divan-output.txt
          retention-days: 1

  perf-gungraun:
    runs-on: depot-ubuntu-24.04-32

    steps:
      - uses: actions/checkout@v5

      - name: Install valgrind (required by gungraun)
        run: sudo apt-get update && sudo apt-get install -y valgrind

      - uses: Swatinem/rust-cache@v2

      - name: Install gungraun-runner
        run: cargo install gungraun-runner@0.17.0

      - name: ✨ Run gungraun benchmarks
        run: |
          cd facet-perf-shootout
          cargo bench --bench unified_gungraun --features jit -- --nocapture | tee gungraun-output.txt

      - name: Upload gungraun results
        uses: actions/upload-artifact@v4
        with:
          name: gungraun-results
          path: facet-perf-shootout/gungraun-output.txt
          retention-days: 1

  perf-publish:
    runs-on: depot-ubuntu-24.04-32
    needs: [perf-divan, perf-gungraun]

    permissions:
      contents: write  # For pushing to perf.facet.rs

    concurrency:
      group: perf-push  # Global concurrency - only one push at a time
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Need full git history

      - uses: Swatinem/rust-cache@v2

      - name: Download divan results
        uses: actions/download-artifact@v4
        with:
          name: divan-results
          path: bench-reports

      - name: Download gungraun results
        uses: actions/download-artifact@v4
        with:
          name: gungraun-results
          path: bench-reports

      - name: Rename benchmark files
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mv bench-reports/divan-output.txt bench-reports/divan-${TIMESTAMP}.txt
          mv bench-reports/gungraun-output.txt bench-reports/gungraun-${TIMESTAMP}.txt

      - name: Set up SSH deploy key
        shell: bash
        env:
          DEPLOY_KEY: ${{ secrets.PERF_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/perf_deploy_key
          chmod 600 ~/.ssh/perf_deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ✨ Generate index and publish
        shell: bash
        env:
          # SSH deploy key for pushing to perf.facet.rs (env var inherited by subprocesses)
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/perf_deploy_key -o IdentitiesOnly=yes"
          # Pass metadata to benchmark-analyzer for correct PR handling
          # All potentially unsafe inputs are passed via env vars (safe pattern)
          BRANCH_ORIGINAL: ${{ github.head_ref || github.ref_name }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Compute COMMIT and COMMIT_SHORT from env vars
          if [ -n "$PR_HEAD_SHA" ]; then
            export COMMIT="$PR_HEAD_SHA"
            export COMMIT_SHORT="${PR_HEAD_SHA:0:8}"
            export COMMIT_MESSAGE="$PR_TITLE"
          else
            # Walk to the actual work commit, not a merge commit
            # For merge commits (from merge_group), walk to ^2 (the PR branch, not main)
            # For regular commits, use as-is
            COMMIT="$(git rev-parse HEAD)"
            PARENT_COUNT=$(git rev-list --parents -n 1 "$COMMIT" | wc -w)
            if [ "$PARENT_COUNT" -gt 2 ]; then
              # Merge commit: ^1 is main (where we merge to), ^2 is the PR (what we merge)
              echo "Detected merge commit $COMMIT, walking to second parent (PR branch)..."
              COMMIT="$(git rev-parse "$COMMIT^2")"
            fi
            export COMMIT
            export COMMIT_SHORT="$(git rev-parse --short "$COMMIT")"
            export COMMIT_MESSAGE="$(git log -1 --format='%s' "$COMMIT")"
          fi
          cargo xtask bench --no-run --push

  nightly:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-miri-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nightly feature tests (simd auto-detected)
        shell: bash
        run: |
          cargo nextest run --package facet-core

  msrv:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check MSRV
        shell: bash
        run: |
          just msrv

  docs:
    runs-on: depot-ubuntu-24.04-32

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check documentation
        shell: bash
        env:
          RUSTDOCFLAGS: -D warnings
        run: |
          just docs

  lockfile:
    runs-on: depot-ubuntu-24.04-4

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Check lockfile is updated
        shell: bash
        run: |
          cargo update --workspace --locked

  clippy:
    runs-on: depot-ubuntu-24.04-16

    container:
      image: ghcr.io/facet-rs/facet-ci:latest-amd64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run clippy
        shell: bash
        run: |
          cargo clippy --workspace --all-features --all-targets --keep-going -- -D warnings --allow deprecated

  test-aarch64-apple-darwin:
    runs-on: mac-arm64-oakhost
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2
        with:
          cache-bin: "false"

      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ✨ Run nextest tests (macOS)
        shell: bash
        run: |
          cargo nextest run --features ci

  test-aarch64-unknown-linux-gnu:
    runs-on: depot-ubuntu-24.04-arm-32
    container:
      image: ghcr.io/facet-rs/facet-ci:latest-arm64
    steps:
      - uses: actions/checkout@v5

      - uses: Swatinem/rust-cache@v2

      - name: ✨ Run nextest tests (Linux ARM64)
        shell: bash
        run: |
          cargo nextest run --features ci

  test-x86_64-pc-windows-msvc:
    runs-on: depot-windows-2025-32
    steps:
      - uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ✨ Run nextest tests (Windows)
        shell: bash
        run: |
          cargo nextest run --features ci

  test-tokio-postgres:
    runs-on: depot-ubuntu-24.04-4

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: ✨ Run facet-tokio-postgres tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        run: |
          cargo nextest run -p facet-tokio-postgres --features test-postgres
